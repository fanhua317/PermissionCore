<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.permacore.iam.mapper.PermissionMapper">

    <!-- 根据用户ID查询所有权限标识（包含角色继承） -->
    <select id="getUserPermissions" resultType="java.lang.String">
        SELECT DISTINCT p.perm_key
        FROM sys_permission p
        WHERE p.status = 1
        AND p.id IN (
        -- 查询用户所有角色的直接权限
        SELECT rp.permission_id
        FROM sys_role_permission rp
        WHERE rp.role_id IN (
        -- 查询用户的所有角色（包含继承的祖先角色）
        WITH RECURSIVE role_tree AS (
        -- 锚点：用户的直接角色
        SELECT ur.role_id
        FROM sys_user_role ur
        WHERE ur.user_id = #{userId}
        UNION ALL
        -- 递归：查询父角色
        SELECT ri.ancestor_id
        FROM sys_role_inheritance ri
        INNER JOIN role_tree rt ON ri.descendant_id = rt.role_id
        )
        SELECT DISTINCT role_id FROM role_tree
        )
        )
    </select>

    <!-- 根据权限ID列表查询权限标识 -->
    <select id="selectPermKeysByIds" resultType="java.lang.String">
        SELECT perm_key
        FROM sys_permission
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = 1
    </select>

    <!-- 查询角色的所有权限ID -->
    <select id="selectPermissionIdsByRoleIds" resultType="java.lang.Long">
        SELECT DISTINCT permission_id
        FROM sys_role_permission
        WHERE role_id IN
        <foreach collection="roleIds" item="roleId" open="(" separator="," close=")">
            #{roleId}
        </foreach>
    </select>
</mapper>