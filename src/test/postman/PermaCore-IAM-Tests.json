{
  "info": {
    "name": "PermaCore IAM API Tests",
    "description": "企业级RBAC3权限管理系统完整测试集合\n包含：认证、用户管理、角色管理、权限测试",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. 用户登录",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// 测试登录是否成功",
              "pm.test(\"登录成功，返回200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "// 验证返回结构",
              "pm.test(\"返回值包含accessToken和refreshToken\", function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.code).to.equal(200);",
              "    pm.expect(jsonData.data).to.have.property(\"accessToken\");",
              "    pm.expect(jsonData.data).to.have.property(\"refreshToken\");",
              "    pm.expect(jsonData.data.tokenType).to.equal(\"Bearer\");",
              "});",
              "",
              "// 保存Token到环境变量",
              "const jsonData = pm.response.json();",
              "pm.environment.set(\"accessToken\", jsonData.data.accessToken);",
              "pm.environment.set(\"refreshToken\", jsonData.data.refreshToken);",
              "pm.environment.set(\"tokenType\", jsonData.data.tokenType);",
              "pm.environment.set(\"tokenExpiresIn\", jsonData.data.expiresIn);",
              "",
              "console.log(\"Token已保存:\", jsonData.data.accessToken.substring(0, 30) + \"...\");"
            ],
            "type": "text/javascript"
          }
        },
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// 登录前可以添加加密密码逻辑（可选）",
              "// 这里演示的是明文密码，实际项目应使用HTTPS"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"Admin@123456\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["api", "auth", "login"]
        },
        "description": "使用管理员账号登录，获取JWT Token\n请求体示例：\n{\n  \"username\": \"admin\",\n  \"password\": \"Admin@123456\"\n}"
      },
      "response": []
    },
    {
      "name": "2. 查询用户列表（需认证）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// 测试认证是否成功",
              "pm.test(\"认证成功，返回200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "// 验证返回数据结构",
              "pm.test(\"返回分页数据结构\", function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.code).to.equal(200);",
              "    pm.expect(jsonData.data).to.have.property(\"records\");",
              "    pm.expect(jsonData.data).to.have.property(\"total\");",
              "    pm.expect(jsonData.data).to.have.property(\"pageNo\");",
              "    pm.expect(jsonData.data).to.have.property(\"pageSize\");",
              "});",
              "",
              "// 验证返回至少一条数据",
              "pm.test(\"返回至少一条用户数据\", function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.data.records.length).to.be.above(0);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{tokenType}} {{accessToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/user/page?pageNo=1&pageSize=10",
          "host": ["{{baseUrl}}"],
          "path": ["api", "user", "page"],
          "query": [
            {
              "key": "pageNo",
              "value": "1"
            },
            {
              "key": "pageSize",
              "value": "10"
            }
          ]
        },
        "description": "分页查询用户列表\n权限要求：system:user:query 或 user:view\n需要在Header中携带Bearer Token"
      },
      "response": []
    },
    {
      "name": "3. 测试权限不足场景（403）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// 测试权限不足是否返回403",
              "pm.test(\"权限不足，返回403\", function () {",
              "    pm.response.to.have.status(403);",
              "});",
              "",
              "// 验证返回码和消息",
              "pm.test(\"返回FORBIDDEN错误码\", function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.code).to.equal(403);",
              "    pm.expect(jsonData.msg).to.include(\"不足\");",
              "});",
              "",
              "console.log(\"权限测试通过：普通用户无法访问管理员接口\");"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "{{tokenType}} {{accessToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/test/user-delete",
          "host": ["{{baseUrl}}"],
          "path": ["api", "test", "user-delete"]
        },
        "description": "测试@PreAuthorize注解的权限控制\n预期结果：返回403 Forbidden\n权限要求：user:delete（admin账号默认拥有）"
      },
      "response": []
    },
    {
      "name": "4. 刷新Token",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// 测试刷新Token是否成功",
              "pm.test(\"刷新Token成功，返回200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "// 验证返回的新Token",
              "pm.test(\"返回新的accessToken\", function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.code).to.equal(200);",
              "    pm.expect(jsonData.data).to.have.property(\"accessToken\");",
              "    pm.expect(jsonData.data.tokenType).to.equal(\"Bearer\");",
              "});",
              "",
              "// 更新环境变量中的accessToken",
              "const jsonData = pm.response.json();",
              "pm.environment.set(\"accessToken\", jsonData.data.accessToken);",
              "pm.environment.set(\"tokenExpiresIn\", jsonData.data.expiresIn);",
              "",
              "console.log(\"Token已刷新，新Token:\", jsonData.data.accessToken.substring(0, 30) + \"...\");"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{tokenType}} {{accessToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"refreshToken\": \"{{refreshToken}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/auth/refresh",
          "host": ["{{baseUrl}}"],
          "path": ["api", "auth", "refresh"]
        },
        "description": "使用RefreshToken获取新的AccessToken\n请求头需要携带旧Token进行认证"
      },
      "response": []
    },
    {
      "name": "5. 用户登出",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// 测试登出是否成功",
              "pm.test(\"登出成功，返回200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "// 验证返回消息",
              "pm.test(\"返回成功消息\", function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.code).to.equal(200);",
              "});",
              "",
              "// 清除Token（可选）",
              "// pm.environment.unset(\"accessToken\");",
              "// pm.environment.unset(\"refreshToken\");",
              "",
              "console.log(\"用户已登出，Token已失效\");"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "{{tokenType}} {{accessToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/auth/logout",
          "host": ["{{baseUrl}}"],
          "path": ["api", "auth", "logout"]
        },
        "description": "用户登出，使当前Token失效\n原理：删除Redis中的JWT版本号"
      },
      "response": []
    },
    {
      "name": "6. 创建用户（管理员权限）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// 测试创建用户权限",
              "pm.test(\"应具有user:add权限\", function () {",
              "    const jsonData = pm.response.json();",
              "    pm.expect([200, 403]).to.include(pm.response.code);",
              "});",
              "",
              "// 如果成功，记录创建的用户ID",
              "if (pm.response.code === 200) {",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.code).to.equal(200);",
              "    console.log(\"用户创建成功\");",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "{{tokenType}} {{accessToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"testuser_\" + Math.random().toString(36).substr(2, 6),\n  \"password\": \"Test@123456\",\n  \"nickname\": \"测试用户\",\n  \"email\": \"test@example.com\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/user",
          "host": ["{{baseUrl}}"],
          "path": ["api", "user"]
        },
        "description": "创建新用户（需要user:add权限）\n用户名使用随机数避免重复"
      },
      "response": []
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 集合级别前置脚本（所有请求执行前）",
          "// 检查Token是否即将过期",
          "const token = pm.environment.get(\"accessToken\");",
          "if (token) {",
          "    // 这里可以添加Token过期时间检查逻辑",
          "    // 如果即将过期，自动调用刷新接口",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 集合级别后置脚本（所有请求执行后）",
          "// 统一错误处理"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "accessToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "refreshToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "tokenType",
      "value": "Bearer",
      "type": "string"
    }
  ]
}