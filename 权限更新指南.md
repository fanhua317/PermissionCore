# 权限更新指南

## 问题说明

超级管理员登录后提示"权限不够"是因为数据库中缺少必要的权限记录。

## 解决方案

### 方案一：使用数据库客户端（推荐）

1. 打开您的数据库客户端工具（如 Navicat、DataGrip、MySQL Workbench 等）

2. 连接到 `permacore_iam` 数据库

3. 打开并执行 SQL 文件：
   ```
   src/main/resources/db/init-permissions.sql
   ```

4. 执行成功后，重启后端应用或清除权限缓存

5. 重新登录 admin 账户即可

### 方案二：使用 MySQL 命令行

```bash
# Windows
cd "c:\Users\Administrator\IdeaProjects\Permission Core"
mysql -uroot -p permacore_iam < src\main\resources\db\init-permissions.sql

# Linux/Mac
cd /path/to/Permission\ Core
mysql -uroot -p permacore_iam < src/main/resources/db/init-permissions.sql
```

### 方案三：手动执行 SQL（如果上述方法都不可用）

如果无法执行 SQL 文件，可以直接在数据库中执行以下关键语句：

```sql
USE permacore_iam;

-- 1. 创建超级管理员角色
INSERT INTO sys_role (role_key, role_name, role_type, sort_order, status, remark, create_time)
VALUES ('ROLE_ADMIN', '超级管理员', 1, 0, 1, '拥有所有权限', NOW());

-- 2. 获取角色ID（记住这个ID，后面会用到）
SELECT @role_id := id FROM sys_role WHERE role_key = 'ROLE_ADMIN';

-- 3. 创建所有必要权限（执行以下所有INSERT语句）
INSERT INTO sys_permission (perm_key, perm_name, resource_type, status, create_time) VALUES
('system:user:query', '用户-查询', 2, 1, NOW()),
('user:add', '用户-创建', 2, 1, NOW()),
('user:edit', '用户-编辑', 2, 1, NOW()),
('user:delete', '用户-删除', 2, 1, NOW()),
('user:assignRole', '用户-分配角色', 2, 1, NOW()),
('system:role:query', '角色-查询', 2, 1, NOW()),
('role:add', '角色-创建', 2, 1, NOW()),
('role:edit', '角色-编辑', 2, 1, NOW()),
('role:delete', '角色-删除', 2, 1, NOW()),
('role:assignPermission', '角色-分配权限', 2, 1, NOW()),
('role:setInheritance', '角色-设置继承', 2, 1, NOW()),
('system:permission:query', '权限-查询', 2, 1, NOW()),
('permission:add', '权限-创建', 2, 1, NOW()),
('permission:edit', '权限-编辑', 2, 1, NOW()),
('permission:delete', '权限-删除', 2, 1, NOW()),
('system:dept:query', '部门-查询', 2, 1, NOW()),
('dept:add', '部门-创建', 2, 1, NOW()),
('dept:edit', '部门-编辑', 2, 1, NOW()),
('dept:delete', '部门-删除', 2, 1, NOW()),
('system:log:query', '日志-查询', 2, 1, NOW()),
('log:delete', '日志-删除', 2, 1, NOW());

-- 4. 将所有权限分配给超级管理员角色
INSERT INTO sys_role_permission (role_id, permission_id, create_time)
SELECT @role_id, p.id, NOW()
FROM sys_permission p
WHERE p.status = 1;

-- 5. 将 admin 用户绑定到超级管理员角色
INSERT INTO sys_user_role (user_id, role_id, create_time)
SELECT u.id, @role_id, NOW()
FROM sys_user u
WHERE u.username = 'admin';
```

## 验证权限是否生效

执行以下查询检查权限配置：

```sql
-- 查看 admin 用户的角色
SELECT r.role_name, r.role_key
FROM sys_user u
JOIN sys_user_role ur ON u.id = ur.user_id
JOIN sys_role r ON ur.role_id = r.id
WHERE u.username = 'admin';

-- 查看超级管理员角色的权限
SELECT p.perm_key, p.perm_name
FROM sys_role r
JOIN sys_role_permission rp ON r.id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.id
WHERE r.role_key = 'ROLE_ADMIN'
ORDER BY p.perm_key;
```

## 重启应用

权限更新后，务必：
1. **重启后端应用**（最简单）
   或
2. **清除 Redis 缓存**（如果使用 Redis）
   ```bash
   redis-cli
   > FLUSHDB
   ```

## 完整的权限列表

更新后，超级管理员将拥有以下权限：

### 用户管理
- `system:user:query` - 查询用户
- `user:add` - 创建用户
- `user:edit` - 编辑用户
- `user:delete` - 删除用户
- `user:assignRole` - 分配角色

### 角色管理
- `system:role:query` - 查询角色
- `role:add` - 创建角色
- `role:edit` - 编辑角色
- `role:delete` - 删除角色
- `role:assignPermission` - 分配权限
- `role:setInheritance` - 设置继承

### 权限管理
- `system:permission:query` - 查询权限
- `permission:add` - 创建权限
- `permission:edit` - 编辑权限
- `permission:delete` - 删除权限

### 部门管理
- `system:dept:query` - 查询部门
- `dept:add` - 创建部门 ✅ **解决创建部门失败问题**
- `dept:edit` - 编辑部门
- `dept:delete` - 删除部门

### 日志管理
- `system:log:query` - 查询日志
- `log:delete` - 删除日志

## 常见问题

### Q: 更新后还是提示权限不够？
**A:** 请确保：
1. SQL 执行成功（检查是否有错误提示）
2. 已重启后端应用
3. 已重新登录（清除浏览器 Token）

### Q: 如何检查当前用户的权限？
**A:** 登录后访问：`/api/auth/info` 接口可以看到当前用户的权限列表

### Q: 部门创建还是失败？
**A:** 检查：
1. 是否已经执行权限更新
2. 是否已重启应用
3. 查看后端日志是否有具体错误信息

---

**更新完成后记得重启应用！**
